# å¹¶å‘æ—¶åºæ³³é“å›¾å¯è§†åŒ–å‡çº§

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡å‡çº§å°†åŸæœ‰çš„"å¹³é¢æ—¥å¿—"å‡çº§ä¸º"å¹¶å‘æ—¶åºæ³³é“å›¾"ï¼ˆSwim Lane Gantt Chartï¼‰ï¼Œä»¥å¾®è§‚çš„æ–¹å¼å¯è§†åŒ–å¹¶å‘è¯·æ±‚çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ¸…æ™°å±•ç¤ºç«æ€æ¡ä»¶çš„å‘ç”Ÿæ—¶æœºã€‚

## ğŸ¯ å‡çº§ç›®æ ‡

1. **æ—¶åºå¯è§†åŒ–**ï¼šå°†æ¯ä¸ªè¯·æ±‚çš„æ‰§è¡Œè¿‡ç¨‹æŒ‰æ—¶é—´è½´å±•ç¤º
2. **å¹¶å‘å±•ç¤º**ï¼šä¸åŒè¯·æ±‚å æ®ä¸åŒæ³³é“ï¼Œæ¸…æ™°æ˜¾ç¤ºå¹¶å‘æ‰§è¡Œ
3. **å†²çªæ ‡è®°**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶é«˜äº®æ˜¾ç¤ºç«æ€çª—å£
4. **å¾®ç§’çº§ç²¾åº¦**ï¼šä½¿ç”¨çº³ç§’çº§æ—¶é—´æˆ³ï¼Œç²¾ç¡®è®°å½•æ¯ä¸ªæ“ä½œé˜¶æ®µ

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯æ”¹é€ 

#### 1. æ•°æ®ç»“æ„æ‰©å±•ï¼ˆservice/account_service.goï¼‰

```go
// Timeline è®°å½•æ“ä½œçš„æ—¶é—´çº¿
type Timeline struct {
    ReadStart    int64 // è¯»å–å¼€å§‹æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    ReadEnd      int64 // è¯»å–ç»“æŸæ—¶é—´ï¼ˆçº³ç§’ï¼‰
    ComputeStart int64 // è®¡ç®—å¼€å§‹æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    ComputeEnd   int64 // è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆçº³ç§’ï¼‰
    WriteStart   int64 // å†™å…¥å¼€å§‹æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    WriteEnd     int64 // å†™å…¥ç»“æŸæ—¶é—´ï¼ˆçº³ç§’ï¼‰
}

// DeductResponse æ‰©å±•å“åº”
type DeductResponse struct {
    // ... åŸæœ‰å­—æ®µ
    Timeline Timeline `json:"timeline"` // æ–°å¢æ—¶é—´çº¿æ•°æ®
}
```

#### 2. åŸ‹ç‚¹è®°å½•ï¼ˆservice/account_service.goï¼‰

åœ¨ `DeductBalance` å’Œ `DeductBalanceWithLock` æ–¹æ³•ä¸­æ·»åŠ çº³ç§’çº§æ—¶é—´æˆ³ï¼š

```go
// è¯»å–é˜¶æ®µ
timeline.ReadStart = time.Now().UnixNano()
account, err := s.GetAccount(req.UserID)
timeline.ReadEnd = time.Now().UnixNano()

// è®¡ç®—é˜¶æ®µ
timeline.ComputeStart = time.Now().UnixNano()
time.Sleep(10 * time.Millisecond) // ä¸šåŠ¡å»¶è¿Ÿ
newBalance := account.Balance - req.Amount
timeline.ComputeEnd = time.Now().UnixNano()

// å†™å…¥é˜¶æ®µ
timeline.WriteStart = time.Now().UnixNano()
db.Model(&model.Account{}).Update("balance", newBalance)
timeline.WriteEnd = time.Now().UnixNano()
```

#### 3. æ³³é“äº‹ä»¶å­˜å‚¨ï¼ˆapi/handler.goï¼‰

```go
// SwimLaneEvent æ³³é“å›¾äº‹ä»¶
type SwimLaneEvent struct {
    RequestID     string // è¯·æ±‚IDï¼ˆæ³³é“æ ‡è¯†ï¼‰
    OperationType string // æ“ä½œç±»å‹: "read", "compute", "write"
    StartTime     int64  // å¼€å§‹æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    EndTime       int64  // ç»“æŸæ—¶é—´ï¼ˆçº³ç§’ï¼‰
    Balance       int64  // ä½™é¢å€¼
    Amount        int64  // æ‰£æ¬¾é‡‘é¢
    NewBalance    int64  // æ–°ä½™é¢
    Status        string // çŠ¶æ€: "success", "failed"
}

var (
    swimLaneEvents      []SwimLaneEvent
    swimLaneEventsMutex sync.RWMutex
    maxSwimLaneEvents   = 500 // æœ€å¤šä¿å­˜500ä¸ªäº‹ä»¶
)
```

#### 4. APIæ¥å£ï¼ˆapi/handler.goï¼‰

æ–°å¢ä¸¤ä¸ªAPIæ¥å£ï¼š

- `GET /api/swimlane` - è·å–æ³³é“å›¾æ•°æ®
- `POST /api/swimlane/clear` - æ¸…é™¤æ³³é“å›¾æ•°æ®

### å‰ç«¯å¯è§†åŒ–

#### 1. å¼•å…¥EChartsåº“

```html
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
```

#### 2. HTMLç»“æ„

```html
<!-- å¹¶å‘æ—¶åºæ³³é“å›¾ -->
<div class="card" style="grid-column: span 2;">
    <h2 class="card-title">ğŸŠ å¹¶å‘æ—¶åºæ³³é“å›¾ï¼ˆå¾®è§‚ç”˜ç‰¹å›¾ï¼‰</h2>
    <div id="swimLaneChart" style="width: 100%; height: 500px;"></div>
</div>
```

#### 3. æ•°æ®æ¸²æŸ“é€»è¾‘

ä¸»è¦å‡½æ•°ï¼š

- `initSwimLaneChart()` - åˆå§‹åŒ–EChartså›¾è¡¨
- `refreshSwimLane()` - ä»APIè·å–æœ€æ–°æ•°æ®
- `renderSwimLane(events)` - æ¸²æŸ“æ³³é“å›¾
- `detectRaceConditions(events)` - æ£€æµ‹å¹¶æ ‡è®°ç«æ€çª—å£
- `renderGanttItem()` - è‡ªå®šä¹‰æ¸²æŸ“ç”˜ç‰¹å›¾æ¡

#### 4. å¯è§†åŒ–è¦ç´ 

**æ¨ªè½´ï¼ˆXè½´ï¼‰**ï¼šæ—¶é—´è½´ï¼ˆå¾®ç§’/æ¯«ç§’çº§ï¼‰
**çºµè½´ï¼ˆYè½´ï¼‰**ï¼šå¹¶å‘è¯·æ±‚IDï¼ˆæ¯ä¸ªè¯·æ±‚ä¸€æ¡æ³³é“ï¼‰

**è‰²å—æ ‡è¯†**ï¼š
- ğŸ”µ **è“è‰²å—**ï¼šè¯»å–æ•°æ®åº“æ“ä½œ
- ğŸŸ¡ **é»„è‰²å—**ï¼šä¸šåŠ¡è®¡ç®—/å»¶è¿Ÿï¼ˆç«æ€çª—å£é«˜å‘åŒºï¼‰
- ğŸŸ¢ **ç»¿è‰²å—**ï¼šå†™å…¥æ•°æ®åº“æ“ä½œ
- ğŸ”´ **çº¢è‰²åŠé€æ˜åŒºåŸŸ**ï¼šæ£€æµ‹åˆ°çš„ç«æ€çª—å£

## ğŸ“Š å¯è§†åŒ–æ•ˆæœ

### æ— é”æ¨¡å¼ä¸‹çš„å…¸å‹åœºæ™¯

```
è¯·æ±‚1: [ğŸ”µ è¯»1000] ----[ğŸŸ¡ å¤„ç†]---- [ğŸŸ¢ å†™990]
è¯·æ±‚2:     [ğŸ”µ è¯»1000] ----[ğŸŸ¡ å¤„ç†]---- [ğŸŸ¢ å†™990]
                    â†‘ ç«æ€çª—å£ â†‘
```

**å…³é”®å‘ç°**ï¼š
- è¯·æ±‚1å’Œè¯·æ±‚2çš„é»„è‰²åŒºåŸŸï¼ˆè®¡ç®—é˜¶æ®µï¼‰åœ¨æ—¶é—´è½´ä¸Šé‡å 
- ä¸¤ä¸ªè¯·æ±‚éƒ½è¯»åˆ°äº†ç›¸åŒçš„ä½™é¢ï¼ˆ1000ï¼‰
- åå†™å…¥çš„è¯·æ±‚è¦†ç›–äº†å…ˆå†™å…¥çš„ç»“æœ
- çº¢è‰²åŠé€æ˜åŒºåŸŸæ ‡è®°äº†ç«æ€çª—å£

### åŠ é”æ¨¡å¼ä¸‹çš„åœºæ™¯

```
è¯·æ±‚1: [ğŸ”µ è¯»1000] ----[ğŸŸ¡ å¤„ç†]---- [ğŸŸ¢ å†™990]
è¯·æ±‚2:                                     [ğŸ”µ è¯»990] ----[ğŸŸ¡ å¤„ç†]---- [ğŸŸ¢ å†™980]
```

**å…³é”®å‘ç°**ï¼š
- è¯·æ±‚ä¹‹é—´å®Œå…¨ä¸²è¡Œï¼Œæ— æ—¶é—´é‡å 
- æ— ç«æ€çª—å£æ ‡è®°
- æ¯ä¸ªè¯·æ±‚éƒ½èƒ½è¯»åˆ°æ­£ç¡®çš„æœ€æ–°å€¼

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨é¡¹ç›®

```bash
# Windows
.\scripts\start.bat

# æˆ–æ‰‹åŠ¨å¯åŠ¨
docker-compose up -d
go run main.go
```

### 2. è®¿é—®Webç•Œé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8080

### 3. è§¦å‘å¹¶å‘è¯·æ±‚

1. è®¾ç½®åˆå§‹ä½™é¢ï¼ˆå¦‚1000å…ƒï¼‰
2. è®¾ç½®å¹¶å‘æ•°ï¼ˆå¦‚10ï¼‰
3. è®¾ç½®æ¯æ¬¡æ‰£æ¬¾é‡‘é¢ï¼ˆå¦‚10å…ƒï¼‰
4. ç‚¹å‡»"ğŸš€ å‘èµ·å¹¶å‘æ”»å‡»"æŒ‰é’®

### 4. è§‚å¯Ÿæ³³é“å›¾

- æ³³é“å›¾æ¯2ç§’è‡ªåŠ¨åˆ·æ–°
- å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»"ğŸ”„ åˆ·æ–°"æŒ‰é’®
- ç‚¹å‡»"ğŸ—‘ï¸ æ¸…ç©º"æ¸…é™¤å†å²æ•°æ®

### 5. åˆ‡æ¢æ¨¡å¼å¯¹æ¯”

- ç‚¹å‡»"åŠ é”æ¨¡å¼"å¼€å…³
- è§‚å¯Ÿæ— é”æ¨¡å¼å’ŒåŠ é”æ¨¡å¼ä¸‹æ³³é“å›¾çš„å·®å¼‚
- ç‰¹åˆ«å…³æ³¨ç«æ€çª—å£çš„å‡ºç°ä¸æ¶ˆå¤±

## ğŸ¨ å¯è§†åŒ–äº®ç‚¹

### 1. å¾®ç§’çº§ç²¾åº¦
ä½¿ç”¨ `time.Now().UnixNano()` è®°å½•çº³ç§’çº§æ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°å¾®ç§’çº§åˆ«ã€‚

### 2. è‡ªåŠ¨å†²çªæ£€æµ‹
ç®—æ³•è‡ªåŠ¨æ£€æµ‹è®¡ç®—é˜¶æ®µçš„æ—¶é—´é‡å ï¼Œæ ‡è®°ä¸ºç«æ€çª—å£ï¼š

```javascript
function detectRaceConditions(events, baseTime) {
    const computeEvents = events.filter(e => e.operation_type === 'compute');
    
    for (let i = 0; i < computeEvents.length; i++) {
        for (let j = i + 1; j < computeEvents.length; j++) {
            const e1 = computeEvents[i];
            const e2 = computeEvents[j];
            
            // æ£€æŸ¥æ—¶é—´é‡å 
            if (e1.relEnd > e2.relStart) {
                // æ ‡è®°ç«æ€çª—å£
                markRaceCondition(e1, e2);
            }
        }
    }
}
```

### 3. äº¤äº’å¼å›¾è¡¨
- é¼ æ ‡æ‚¬åœæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆè¯·æ±‚IDã€æ“ä½œç±»å‹ã€ä½™é¢ã€è€—æ—¶ï¼‰
- ç¼©æ”¾å’Œå¹³ç§»æ”¯æŒ
- è‡ªé€‚åº”å¸ƒå±€

### 4. å®æ—¶æ›´æ–°
- æ¯2ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
- æ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢
- æµç•…çš„åŠ¨ç”»æ•ˆæœ

## ğŸ“ˆ æ•™è‚²ä»·å€¼

### å¯¹äºåˆå­¦è€…
1. **ç›´è§‚ç†è§£å¹¶å‘**ï¼šé€šè¿‡æ³³é“å›¾æ¸…æ™°çœ‹åˆ°å¤šä¸ªè¯·æ±‚åŒæ—¶æ‰§è¡Œ
2. **ç«æ€æ¡ä»¶å¯è§†åŒ–**ï¼šçº¢è‰²åŒºåŸŸç›´è§‚å±•ç¤ºé—®é¢˜å‘ç”Ÿçš„æ—¶æœº
3. **å¯¹æ¯”å­¦ä¹ **ï¼šåˆ‡æ¢åŠ é”/æ— é”æ¨¡å¼ï¼Œå¯¹æ¯”æ•ˆæœå·®å¼‚

### å¯¹äºå¼€å‘è€…
1. **æ€§èƒ½åˆ†æ**ï¼šæŸ¥çœ‹æ¯ä¸ªé˜¶æ®µçš„è€—æ—¶
2. **ç“¶é¢ˆå®šä½**ï¼šè¯†åˆ«æ…¢æ“ä½œ
3. **å¹¶å‘è°ƒä¼˜**ï¼šä¼˜åŒ–å¹¶å‘ç­–ç•¥

### å¯¹äºæ¶æ„å¸ˆ
1. **ç³»ç»Ÿè®¾è®¡**ï¼šç†è§£å¹¶å‘æ§åˆ¶çš„é‡è¦æ€§
2. **é”çš„ä»£ä»·**ï¼šè§‚å¯ŸåŠ é”åçš„æ€§èƒ½å½±å“
3. **åˆ†å¸ƒå¼æ€è€ƒ**ï¼šä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡åšé“ºå«

## ğŸ” æ ¸å¿ƒä»£ç ç‰‡æ®µ

### åç«¯åŸ‹ç‚¹
```go
// è®°å½•æ³³é“äº‹ä»¶
func recordSwimLaneEvents(requestID string, resp *service.DeductResponse, amount int64) {
    swimLaneEventsMutex.Lock()
    defer swimLaneEventsMutex.Unlock()

    timeline := resp.Timeline

    // è®°å½•è¯»å–ã€è®¡ç®—ã€å†™å…¥ä¸‰ä¸ªé˜¶æ®µ
    swimLaneEvents = append(swimLaneEvents, 
        SwimLaneEvent{
            RequestID:     requestID,
            OperationType: "read",
            StartTime:     timeline.ReadStart,
            EndTime:       timeline.ReadEnd,
            Balance:       resp.OldBalance,
            Amount:        amount,
            Status:        "success",
        },
        // ... computeå’Œwriteäº‹ä»¶
    )
}
```

### å‰ç«¯æ¸²æŸ“
```javascript
function renderSwimLane(events) {
    // æŒ‰è¯·æ±‚IDåˆ†ç»„
    const requestMap = groupByRequestId(events);
    
    // ç”Ÿæˆæ³³é“æ•°æ®
    const yAxisData = Array.from(requestMap.keys());
    
    // æ¸²æŸ“è‰²å—
    const series = [{
        name: 'è¯»å–',
        type: 'custom',
        renderItem: renderGanttItem,
        itemStyle: { color: '#3b82f6' },
        data: seriesData.read
    }, {
        name: 'è®¡ç®—',
        type: 'custom',
        itemStyle: { color: '#f59e0b' },
        data: seriesData.compute,
        markArea: raceConditions // æ ‡è®°ç«æ€çª—å£
    }, {
        name: 'å†™å…¥',
        type: 'custom',
        itemStyle: { color: '#10b981' },
        data: seriesData.write
    }];
    
    swimLaneChart.setOption({ series });
}
```

## ğŸ“ å­¦ä¹ å»ºè®®

1. **å…ˆæ— é”ååŠ é”**ï¼š
   - å…ˆåœ¨æ— é”æ¨¡å¼ä¸‹è§‚å¯Ÿç«æ€çª—å£
   - ç†è§£é—®é¢˜çš„æœ¬è´¨
   - å†åˆ‡æ¢åˆ°åŠ é”æ¨¡å¼è§‚å¯Ÿè§£å†³æ–¹æ¡ˆ

2. **è°ƒæ•´å¹¶å‘å‚æ•°**ï¼š
   - å°è¯•ä¸åŒçš„å¹¶å‘æ•°ï¼ˆ1, 5, 10, 50ï¼‰
   - è§‚å¯Ÿç«æ€çª—å£çš„å˜åŒ–
   - ç†è§£å¹¶å‘åº¦ä¸å†²çªæ¦‚ç‡çš„å…³ç³»

3. **åˆ†ææ—¶é—´å æ¯”**ï¼š
   - è§‚å¯Ÿè¯»ã€è®¡ç®—ã€å†™ä¸‰ä¸ªé˜¶æ®µçš„è€—æ—¶
   - æ€è€ƒå¦‚ä½•ä¼˜åŒ–æ€§èƒ½
   - ç†è§£é”çš„ç²’åº¦é—®é¢˜

4. **å¯¹æ¯”å®éªŒ**ï¼š
   - è®°å½•æ— é”æ¨¡å¼ä¸‹çš„ä½™é¢ä¸¢å¤±æƒ…å†µ
   - è®°å½•åŠ é”æ¨¡å¼ä¸‹çš„æ€§èƒ½å½±å“
   - æ€è€ƒæƒè¡¡ä¸é€‰æ‹©

## ğŸš€ åç»­æ‰©å±•

1. **åˆ†å¸ƒå¼åœºæ™¯**ï¼š
   - æ¨¡æ‹Ÿå¤šå®ä¾‹éƒ¨ç½²
   - å±•ç¤ºåˆ†å¸ƒå¼é”çš„å¿…è¦æ€§

2. **æ•°æ®åº“é”**ï¼š
   - å±•ç¤ºä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰
   - å±•ç¤ºæ‚²è§‚é”ï¼ˆFOR UPDATEï¼‰

3. **æ€§èƒ½å¯¹æ¯”**ï¼š
   - æ·»åŠ QPSç»Ÿè®¡
   - æ·»åŠ å»¶è¿Ÿåˆ†å¸ƒå›¾

4. **é”™è¯¯æ³¨å…¥**ï¼š
   - æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
   - æ¨¡æ‹Ÿæ•°æ®åº“è¶…æ—¶

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å‡çº§é€šè¿‡å¼•å…¥æ³³é“å›¾å¯è§†åŒ–ï¼Œå°†æŠ½è±¡çš„å¹¶å‘é—®é¢˜å˜å¾—å…·è±¡åŒ–ã€å¯è§‚æµ‹ã€‚ç”¨æˆ·å¯ä»¥ï¼š

- âœ… æ¸…æ™°çœ‹åˆ°æ¯ä¸ªè¯·æ±‚çš„æ‰§è¡Œè¿‡ç¨‹
- âœ… ç›´è§‚ç†è§£ç«æ€æ¡ä»¶çš„å‘ç”Ÿæ—¶æœº
- âœ… å¯¹æ¯”ä¸åŒå¹¶å‘æ§åˆ¶ç­–ç•¥çš„æ•ˆæœ
- âœ… æ·±å…¥ç†è§£å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

è¿™ç§å¯è§†åŒ–æ–¹å¼ä¸ä»…é€‚ç”¨äºæ•™å­¦æ¼”ç¤ºï¼Œä¹Ÿå¯ä»¥åº”ç”¨äºå®é™…ç³»ç»Ÿçš„æ€§èƒ½åˆ†æå’Œé—®é¢˜è¯Šæ–­ã€‚
