<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†²çªå¯è§†åŒ–å™¨ - The Stale Data Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        /* ä¸‰åˆ—å¸ƒå±€ */
        .battle-arena {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            min-height: 600px;
        }
        
        .column {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .column-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid;
        }
        
        .goroutine-a {
            border: 3px solid #3b82f6;
        }
        
        .goroutine-a .column-title {
            color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .database {
            border: 3px solid #10b981;
        }
        
        .database .column-title {
            color: #10b981;
            border-color: #10b981;
        }
        
        .goroutine-b {
            border: 3px solid #f59e0b;
        }
        
        .goroutine-b .column-title {
            color: #f59e0b;
            border-color: #f59e0b;
        }
        
        /* æ•°æ®æ°”æ³¡ */
        .data-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 1.2rem;
            text-align: center;
            transition: all 0.5s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .data-bubble.reading {
            animation: pulse 1s infinite;
            background: #3b82f6;
        }
        
        .data-bubble.computing {
            background: #f59e0b;
        }
        
        .data-bubble.writing {
            animation: glow 0.5s ease-in-out;
            background: #10b981;
        }
        
        .data-bubble.stale {
            background: #ef4444;
            animation: shake 0.5s;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px #10b981; }
            50% { box-shadow: 0 0 20px #10b981; }
            100% { box-shadow: 0 0 5px #10b981; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* æ•°æ®åº“æ˜¾ç¤º */
        .db-display {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            position: relative;
        }
        
        .db-value {
            font-size: 3rem;
            font-weight: bold;
            color: #10b981;
            transition: all 0.5s ease;
        }
        
        .db-value.updating {
            animation: flip 0.6s;
            color: #3b82f6;
        }
        
        .db-value.conflict {
            color: #ef4444;
            animation: blink 0.5s 3;
        }
        
        @keyframes flip {
            0% { transform: rotateX(0); }
            50% { transform: rotateX(90deg); }
            100% { transform: rotateX(0); }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .db-lock {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            animation: lockAppear 0.5s;
        }
        
        @keyframes lockAppear {
            0% { transform: translateX(-50%) translateY(-50px) scale(0); }
            100% { transform: translateX(-50%) translateY(0) scale(1); }
        }
        
        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
            opacity: 0.3;
            transition: all 0.3s;
        }
        
        .step.active {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .step.step-1 { background: #dbeafe; color: #1e40af; }
        .step.step-2 { background: #fef3c7; color: #92400e; }
        .step.step-3 { background: #d1fae5; color: #065f46; }
        
        /* è­¦å‘Šæ¡† */
        .warning-box {
            background: #fee2e2;
            border: 3px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            animation: slideIn 0.5s;
        }
        
        .warning-box.show {
            display: block;
        }
        
        .warning-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #991b1b;
            margin-bottom: 10px;
        }
        
        .warning-content {
            font-size: 1rem;
            color: #7f1d1d;
            line-height: 1.6;
        }
        
        @keyframes slideIn {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-control {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .stage-indicators {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .stage-indicator {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #e0e0e0;
            margin: 0 5px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .stage-indicator.active {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .stage-indicator:hover {
            background: #5568d3;
            color: white;
        }
        
        /* è¿æ¥çº¿ */
        .connection-line {
            position: absolute;
            height: 3px;
            background: #667eea;
            transform-origin: left center;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .connection-line.active {
            opacity: 1;
            animation: drawLine 0.5s;
        }
        
        @keyframes drawLine {
            0% { width: 0; }
            100% { width: 100%; }
        }
        
        .info-text {
            text-align: center;
            padding: 15px;
            background: #dbeafe;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.95rem;
            color: #1e40af;
        }
        
        /* æ—¶é—´è½´æ˜¾ç¤º */
        .timeline-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .timeline-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 0.85rem;
        }
        
        .timeline-item:last-child {
            border-bottom: none;
        }
        
        .timeline-label {
            font-weight: 600;
            color: #6b7280;
        }
        
        .timeline-value {
            color: #1f2937;
        }
        
        .timeline-value.highlight {
            color: #ef4444;
            font-weight: bold;
        }
        
        /* è¯·æ±‚å†å² */
        .request-history {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .request-history h4 {
            margin-bottom: 10px;
            color: #374151;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 8px 12px;
            background: white;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .history-item strong {
            color: #667eea;
        }
        
        .conflict-summary {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .conflict-summary h3 {
            color: #991b1b;
            margin-bottom: 10px;
        }
        
        .conflict-stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 1.05rem;
        }
        
        .conflict-stat strong {
            color: #7f1d1d;
        }
        
        /* æ—¶é—´è½´æ˜¾ç¤º */
        .timeline-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .timeline-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 0.85rem;
        }
        
        .timeline-item:last-child {
            border-bottom: none;
        }
        
        .timeline-label {
            font-weight: 600;
            color: #6b7280;
        }
        
        .timeline-value {
            color: #1f2937;
        }
        
        .timeline-value.highlight {
            color: #ef4444;
            font-weight: bold;
        }
        
        .timeline-value.simultaneous {
            color: #f59e0b;
            font-weight: bold;
        }
        
        /* è¯·æ±‚å†å² */
        .request-history {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .request-history h4 {
            margin-bottom: 10px;
            color: #374151;
            font-size: 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .history-item {
            padding: 10px;
            margin: 8px 0;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .history-item.goroutine-a {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        
        .history-item.goroutine-b {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .history-time {
            font-family: 'Courier New', monospace;
            color: #6b7280;
            font-size: 0.8rem;
        }
        
        .history-action {
            font-weight: 600;
            color: #1f2937;
            margin: 5px 0;
        }
        
        .history-detail {
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        /* æ§åˆ¶æŒ‰é’®ç»„ */
        .playback-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš”ï¸ å¹¶å‘å†²çªå¯è§†åŒ–å™¨</h1>
            <p>The "Stale Data" Visualizer - åŒè¾¹å¯¹å†³ + ä¸­é—´çœŸç†å±‚</p>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="button-group">
                <button class="btn-primary" onclick="loadConflict()">ğŸ”„ åŠ è½½æœ€è¿‘å†²çª</button>
                <button class="btn-success" id="playBtn" onclick="playAnimation()">â–¶ï¸ è‡ªåŠ¨æ’­æ”¾</button>
                <button class="btn-info" id="prevBtn" onclick="prevStage()" disabled>â®ï¸ ä¸Šä¸€æ­¥</button>
                <button class="btn-info" id="nextBtn" onclick="nextStage()" disabled>â­ï¸ ä¸‹ä¸€æ­¥</button>
                <button class="btn-warning" id="pauseBtn" onclick="pauseAnimation()" style="display: none;">â¸ï¸ æš‚åœ</button>
                <button class="btn-danger" onclick="clearConflict()">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
            </div>
            
            <!-- è¿›åº¦æ§åˆ¶ -->
            <div class="progress-control">
                <div class="stage-indicators">
                    <div class="stage-indicator" id="stageBtn0" onclick="goToStage(0)">
                        ğŸ”µ é˜¶æ®µ0<br>åˆå§‹çŠ¶æ€
                    </div>
                    <div class="stage-indicator" id="stageBtn1" onclick="goToStage(1)">
                        ğŸ”µ é˜¶æ®µ1<br>å¹¶å‘è¯»å–
                    </div>
                    <div class="stage-indicator" id="stageBtn2" onclick="goToStage(2)">
                        ğŸŸ¡ é˜¶æ®µ2<br>ä¸šåŠ¡è®¡ç®—
                    </div>
                    <div class="stage-indicator" id="stageBtn3" onclick="goToStage(3)">
                        ğŸŸ¢ é˜¶æ®µ3<br>Aå†™å…¥
                    </div>
                    <div class="stage-indicator" id="stageBtn4" onclick="goToStage(4)">
                        ğŸ”´ é˜¶æ®µ4<br>Bå†™å…¥
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div id="statusMessage" class="info-text" style="margin-top: 15px; display: none;"></div>
        </div>
        
        <!-- ä¸‰åˆ—æˆ˜åœº -->
        <div class="battle-arena">
            <!-- å·¦ä¾§ï¼šGoroutine A -->
            <div class="column goroutine-a">
                <div class="column-title">ğŸ”µ Goroutine A</div>
                
                <div class="step-indicator">
                    <div class="step step-1" id="stepA1">Step 1<br>Read</div>
                    <div class="step step-2" id="stepA2">Step 2<br>Calc</div>
                    <div class="step step-3" id="stepA3">Step 3<br>Write</div>
                </div>
                
                <div id="bubbleA" class="data-bubble">
                    ç­‰å¾…æ•°æ®...
                </div>
                
                <div class="timeline-display" id="timelineA">
                    <h4 style="margin-bottom: 10px; color: #3b82f6;">â±ï¸ æ—¶é—´çº¿</h4>
                    <div class="timeline-item">
                        <span class="timeline-label">è¯»å–æ—¶é—´:</span>
                        <span class="timeline-value" id="timeA_read">-</span>
                    </div>
                    <div class="timeline-item">
                        <span class="timeline-label">è®¡ç®—å¼€å§‹:</span>
                        <span class="timeline-value" id="timeA_calcStart">-</span>
                    </div>
                    <div class="timeline-item">
                        <span class="timeline-label">è®¡ç®—ç»“æŸ:</span>
                        <span class="timeline-value" id="timeA_calcEnd">-</span>
                    </div>
                    <div class="timeline-item">
                        <span class="timeline-label">å†™å…¥æ—¶é—´:</span>
                        <span class="timeline-value" id="timeA_write">-</span>
                    </div>
                </div>
                
                <div class="request-history" id="historyA">
                    <h4>ğŸ“ æ“ä½œå†å²</h4>
                    <div id="historyListA"></div>
                </div>
            </div>
            
            <!-- ä¸­é—´ï¼šDatabase -->
            <div class="column database">
                <div class="column-title">ğŸ’¾ Database (Truth)</div>
                
                <div class="db-display">
                    <div id="dbLock" class="db-lock" style="display: none;">ğŸ”’</div>
                    <div class="db-value" id="dbValue">1000</div>
                    <div style="font-size: 1rem; color: #6b7280; margin-top: 10px;">
                        å½“å‰ä½™é¢ï¼ˆåˆ†ï¼‰
                    </div>
                </div>
                
                <div id="warningBox" class="warning-box">
                    <div class="warning-title">âš ï¸ Stale Data æ£€æµ‹ï¼</div>
                    <div class="warning-content" id="warningContent">
                        è¯·æ±‚Bæ­£åœ¨ä½¿ç”¨è¿‡æ—¶çš„æ•°æ®...
                    </div>
                </div>
                
                <div id="conflictSummary" class="conflict-summary" style="display: none;">
                    <h3>ğŸ“Š å†²çªç»Ÿè®¡</h3>
                    <div class="conflict-stat">
                        <span>åˆå§‹å€¼:</span>
                        <strong id="summaryInitial">-</strong>
                    </div>
                    <div class="conflict-stat">
                        <span>Aå†™å…¥å:</span>
                        <strong id="summaryAfterA">-</strong>
                    </div>
                    <div class="conflict-stat">
                        <span>Bå†™å…¥å:</span>
                        <strong id="summaryAfterB">-</strong>
                    </div>
                    <div class="conflict-stat">
                        <span>ç†è®ºå€¼:</span>
                        <strong id="summaryExpected">-</strong>
                    </div>
                    <div class="conflict-stat">
                        <span>ä¸¢å¤±é‡‘é¢:</span>
                        <strong id="summaryLost" style="color: #ef4444; font-size: 1.3rem;">-</strong>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šGoroutine B -->
            <div class="column goroutine-b">
                <div class="column-title">ğŸŸ¡ Goroutine B</div>
                
                <div class="step-indicator">
                    <div class="step step-1" id="stepB1">Step 1<br>Read</div>
                    <div class="step step-2" id="stepB2">Step 2<br>Calc</div>
                    <div class="step step-3" id="stepB3">Step 3<br>Write</div>
                </div>
                
                <div id="bubbleB" class="data-bubble">
                    ç­‰å¾…æ•°æ®...
                </div>
                
                <div class="timeline-display" id="timelineB">
                    <h4 style="margin-bottom: 10px; color: #f59e0b;">â±ï¸ æ—¶é—´çº¿</h4>
                    <div class="timeline-item">
                        <span class="timeline-label">è¯»å–æ—¶é—´:</span>
                        <span class="timeline-value" id="timeB_read">-</span>
                    </div>
                    <div class="timeline-item">
                        <span class="timeline-label">è®¡ç®—å¼€å§‹:</span>
                        <span class="timeline-value" id="timeB_calcStart">-</span>
                    </div>
                    <div class="timeline-item">
                        <span class="timeline-label">è®¡ç®—ç»“æŸ:</span>
                        <span class="timeline-value" id="timeB_calcEnd">-</span>
                    </div>
                    <div class="timeline-item">
                        <span class="timeline-label">å†™å…¥æ—¶é—´:</span>
                        <span class="timeline-value" id="timeB_write">-</span>
                    </div>
                </div>
                
                <div class="request-history" id="historyB">
                    <h4>ğŸ“ æ“ä½œå†å²</h4>
                    <div id="historyListB"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let conflictData = null;
        let currentStage = 0;
        let isAutoPlaying = false;
        let autoPlayTimer = null;
        
        // æ ¼å¼åŒ–æ—¶é—´æˆ³ï¼ˆçº³ç§’è½¬ä¸ºå¯è¯»æ ¼å¼ï¼‰
        function formatTimestamp(nanoTime) {
            if (!nanoTime) return '-';
            const date = new Date(nanoTime / 1000000); // çº³ç§’è½¬æ¯«ç§’
            return date.toLocaleTimeString('zh-CN', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3 
            });
        }
        
        // è®¡ç®—ç›¸å¯¹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        function getRelativeTime(nanoTime, baseTime) {
            if (!nanoTime || !baseTime) return '-';
            return ((nanoTime - baseTime) / 1000000).toFixed(2) + 'ms';
        }
        
        // åŠ è½½å†²çªæ•°æ®
        async function loadConflict() {
            try {
                const response = await fetch('/api/conflict/snapshot');
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    conflictData = result.data;
                    displayConflict(conflictData);
                    enableControls();
                    goToStage(0);
                    showStatus('âœ… å†²çªæ•°æ®åŠ è½½æˆåŠŸï¼å¯ä»¥ä½¿ç”¨æ­¥è¿›æ§åˆ¶æˆ–è‡ªåŠ¨æ’­æ”¾', 'success');
                } else {
                    showStatus('âš ï¸ æš‚æ— å†²çªæ•°æ®ï¼Œè¯·å…ˆåœ¨ä¸»é¡µå‘èµ·å¹¶å‘æ”»å‡»', 'warning');
                }
            } catch (error) {
                showStatus('âŒ åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºå†²çªæ•°æ®ï¼ˆé™æ€ï¼‰
        function displayConflict(data) {
            // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
            document.getElementById('summaryInitial').textContent = (data.db_initial_value / 100).toFixed(2) + 'å…ƒ';
            document.getElementById('summaryAfterA').textContent = (data.db_after_a / 100).toFixed(2) + 'å…ƒ';
            document.getElementById('summaryAfterB').textContent = (data.db_after_b / 100).toFixed(2) + 'å…ƒ';
            document.getElementById('summaryExpected').textContent = (data.db_expected_b / 100).toFixed(2) + 'å…ƒ';
            document.getElementById('summaryLost').textContent = (data.lost_amount / 100).toFixed(2) + 'å…ƒ';
            document.getElementById('conflictSummary').style.display = 'block';
            
            // è®¡ç®—åŸºå‡†æ—¶é—´ï¼ˆæœ€æ—©çš„è¯»å–æ—¶é—´ï¼‰
            const baseTime = Math.min(data.request_a_read_time, data.request_b_read_time);
            
            // æ›´æ–°Açš„æ—¶é—´çº¿
            document.getElementById('timeA_read').textContent = formatTimestamp(data.request_a_read_time);
            document.getElementById('timeA_calcStart').textContent = formatTimestamp(data.request_a_calc_start) + ' (+' + getRelativeTime(data.request_a_calc_start, baseTime) + ')';
            document.getElementById('timeA_calcEnd').textContent = formatTimestamp(data.request_a_calc_end) + ' (+' + getRelativeTime(data.request_a_calc_end, baseTime) + ')';
            document.getElementById('timeA_write').textContent = formatTimestamp(data.request_a_write_time) + ' (+' + getRelativeTime(data.request_a_write_time, baseTime) + ')';
            
            // æ›´æ–°Bçš„æ—¶é—´çº¿
            document.getElementById('timeB_read').textContent = formatTimestamp(data.request_b_read_time);
            document.getElementById('timeB_calcStart').textContent = formatTimestamp(data.request_b_calc_start) + ' (+' + getRelativeTime(data.request_b_calc_start, baseTime) + ')';
            document.getElementById('timeB_calcEnd').textContent = formatTimestamp(data.request_b_calc_end) + ' (+' + getRelativeTime(data.request_b_calc_end, baseTime) + ')';
            document.getElementById('timeB_write').textContent = formatTimestamp(data.request_b_write_time) + ' (+' + getRelativeTime(data.request_b_write_time, baseTime) + ')';
            
            // ç”Ÿæˆå®Œæ•´çš„æ“ä½œå†å²è®°å½•
            generateFullHistory(data, baseTime);
        }
        
        // ç”Ÿæˆå®Œæ•´çš„æ“ä½œå†å²è®°å½•
        function generateFullHistory(data, baseTime) {
            // åˆ›å»ºæ‰€æœ‰æ“ä½œçš„æ—¶é—´çº¿æ•°ç»„
            const operations = [
                {
                    goroutine: 'A',
                    action: 'è¯»å–ä½™é¢',
                    time: data.request_a_read_time,
                    value: (data.request_a_read_value / 100).toFixed(2),
                    detail: `è¯·æ±‚ID: ${data.request_a_id}`
                },
                {
                    goroutine: 'B',
                    action: 'è¯»å–ä½™é¢',
                    time: data.request_b_read_time,
                    value: (data.request_b_read_value / 100).toFixed(2),
                    detail: `è¯·æ±‚ID: ${data.request_b_id}`
                },
                {
                    goroutine: 'A',
                    action: 'å¼€å§‹è®¡ç®—',
                    time: data.request_a_calc_start,
                    value: '',
                    detail: ''
                },
                {
                    goroutine: 'B',
                    action: 'å¼€å§‹è®¡ç®—',
                    time: data.request_b_calc_start,
                    value: '',
                    detail: ''
                },
                {
                    goroutine: 'A',
                    action: 'å®Œæˆè®¡ç®—',
                    time: data.request_a_calc_end,
                    value: (data.request_a_new_value / 100).toFixed(2),
                    detail: `æ–°å€¼: ${(data.request_a_new_value / 100).toFixed(2)}å…ƒ`
                },
                {
                    goroutine: 'B',
                    action: 'å®Œæˆè®¡ç®—',
                    time: data.request_b_calc_end,
                    value: (data.request_b_new_value / 100).toFixed(2),
                    detail: `æ–°å€¼: ${(data.request_b_new_value / 100).toFixed(2)}å…ƒ`
                },
                {
                    goroutine: 'A',
                    action: 'å†™å…¥æ•°æ®åº“',
                    time: data.request_a_write_time,
                    value: (data.request_a_write_value / 100).toFixed(2),
                    detail: `å†™å…¥å€¼: ${(data.request_a_write_value / 100).toFixed(2)}å…ƒ`
                },
                {
                    goroutine: 'B',
                    action: 'å†™å…¥æ•°æ®åº“',
                    time: data.request_b_write_time,
                    value: (data.request_b_write_value / 100).toFixed(2),
                    detail: `å†™å…¥å€¼: ${(data.request_b_write_value / 100).toFixed(2)}å…ƒ âš ï¸ è¦†ç›–å†™å…¥`
                }
            ];
            
            // æŒ‰æ—¶é—´æ’åº
            operations.sort((a, b) => a.time - b.time);
            
            // ç”ŸæˆHTML
            let historyAHTML = '';
            let historyBHTML = '';
            
            operations.forEach((op, index) => {
                const relTime = getRelativeTime(op.time, baseTime);
                const absTime = formatTimestamp(op.time);
                const itemClass = op.goroutine === 'A' ? 'goroutine-a' : 'goroutine-b';
                
                const html = `
                    <div class="history-item ${itemClass}">
                        <div class="history-time">T+${relTime} (${absTime})</div>
                        <div class="history-action">${op.action}${op.value ? ': ' + op.value + 'å…ƒ' : ''}</div>
                        ${op.detail ? `<div class="history-detail">${op.detail}</div>` : ''}
                    </div>
                `;
                
                if (op.goroutine === 'A') {
                    historyAHTML += html;
                } else {
                    historyBHTML += html;
                }
            });
            
            document.getElementById('historyListA').innerHTML = historyAHTML;
            document.getElementById('historyListB').innerHTML = historyBHTML;
        }
        
        // å¯ç”¨æ§åˆ¶æŒ‰é’®
        function enableControls() {
            document.getElementById('playBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('prevBtn').disabled = false;
        }
        
        // ç¦ç”¨æ§åˆ¶æŒ‰é’®
        function disableControls() {
            document.getElementById('playBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('prevBtn').disabled = true;
        }
        
        // æ’­æ”¾åŠ¨ç”»ï¼ˆè‡ªåŠ¨ï¼‰
        async function playAnimation() {
            if (!conflictData) {
                showStatus('âš ï¸ è¯·å…ˆåŠ è½½å†²çªæ•°æ®', 'warning');
                return;
            }
            
            isAutoPlaying = true;
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            disableControls();
            
            // ä»é˜¶æ®µ0å¼€å§‹è‡ªåŠ¨æ’­æ”¾
            currentStage = 0;
            goToStage(0);
            
            // æ¯1.5ç§’è‡ªåŠ¨å‰è¿›ä¸€ä¸ªé˜¶æ®µ
            autoPlayTimer = setInterval(() => {
                if (currentStage < 4) {
                    nextStage();
                } else {
                    pauseAnimation();
                }
            }, 1500);
        }
        
        // æš‚åœåŠ¨ç”»
        function pauseAnimation() {
            isAutoPlaying = false;
            if (autoPlayTimer) {
                clearInterval(autoPlayTimer);
                autoPlayTimer = null;
            }
            document.getElementById('playBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            enableControls();
        }
        
        // ä¸‹ä¸€æ­¥
        function nextStage() {
            if (currentStage < 4) {
                goToStage(currentStage + 1);
            }
        }
        
        // ä¸Šä¸€æ­¥
        function prevStage() {
            if (currentStage > 0) {
                goToStage(currentStage - 1);
            }
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé˜¶æ®µ
        function goToStage(stage) {
            currentStage = stage;
            updateProgress();
            renderStage(stage);
            updateHistory(stage);
        }
        
        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress() {
            // æ›´æ–°è¿›åº¦æ¡
            const progress = (currentStage / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
            for (let i = 0; i <= 4; i++) {
                const btn = document.getElementById('stageBtn' + i);
                if (i === currentStage) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prevBtn').disabled = (currentStage === 0);
            document.getElementById('nextBtn').disabled = (currentStage === 4);
        }
        
        // æ¸²æŸ“æŒ‡å®šé˜¶æ®µ
        function renderStage(stage) {
            // é‡ç½®æ‰€æœ‰æ­¥éª¤æŒ‡ç¤ºå™¨
            ['stepA1', 'stepA2', 'stepA3', 'stepB1', 'stepB2', 'stepB3'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            
            switch(stage) {
                case 0:
                    stage0_Initial();
                    break;
                case 1:
                    stage1_Read();
                    break;
                case 2:
                    stage2_Calculate();
                    break;
                case 3:
                    stage3_AWrite();
                    break;
                case 4:
                    stage4_BWrite();
                    break;
            }
        }
        
        // é˜¶æ®µ0ï¼šåˆå§‹çŠ¶æ€
        function stage0_Initial() {
            document.getElementById('dbValue').textContent = (conflictData.db_initial_value / 100).toFixed(2);
            document.getElementById('dbValue').className = 'db-value';
            document.getElementById('warningBox').classList.remove('show');
            
            document.getElementById('bubbleA').textContent = 'ç­‰å¾…å¼€å§‹...';
            document.getElementById('bubbleA').className = 'data-bubble';
            document.getElementById('bubbleB').textContent = 'ç­‰å¾…å¼€å§‹...';
            document.getElementById('bubbleB').className = 'data-bubble';
        }
        
        // é˜¶æ®µ1ï¼šå¹¶å‘è¯»å–
        function stage1_Read() {
            const initValue = (conflictData.db_initial_value / 100).toFixed(2);
            
            // Aè¯»å–
            document.getElementById('stepA1').classList.add('active');
            document.getElementById('bubbleA').className = 'data-bubble reading';
            document.getElementById('bubbleA').innerHTML = `
                <strong>ğŸ”µ è¯»å–ä¸­...</strong><br>
                ID: ${conflictData.request_a_id}<br>
                local_balance = ${initValue}å…ƒ
            `;
            
            // Bè¯»å–
            document.getElementById('stepB1').classList.add('active');
            document.getElementById('bubbleB').className = 'data-bubble reading';
            document.getElementById('bubbleB').innerHTML = `
                <strong>ğŸ”µ è¯»å–ä¸­...</strong><br>
                ID: ${conflictData.request_b_id}<br>
                local_balance = ${initValue}å…ƒ
            `;
        }
        
        // é˜¶æ®µ2ï¼šè®¡ç®—
        function stage2_Calculate() {
            const amount = (conflictData.amount / 100).toFixed(2);
            
            // Aè®¡ç®—
            document.getElementById('stepA1').classList.remove('active');
            document.getElementById('stepA2').classList.add('active');
            document.getElementById('bubbleA').className = 'data-bubble computing';
            document.getElementById('bubbleA').innerHTML = `
                <strong>ğŸŸ¡ è®¡ç®—ä¸­...</strong><br>
                ${(conflictData.request_a_read_value / 100).toFixed(2)} - ${amount} = ${(conflictData.request_a_new_value / 100).toFixed(2)}å…ƒ
            `;
            
            // Bè®¡ç®—
            document.getElementById('stepB1').classList.remove('active');
            document.getElementById('stepB2').classList.add('active');
            document.getElementById('bubbleB').className = 'data-bubble computing';
            document.getElementById('bubbleB').innerHTML = `
                <strong>ğŸŸ¡ è®¡ç®—ä¸­...</strong><br>
                ${(conflictData.request_b_read_value / 100).toFixed(2)} - ${amount} = ${(conflictData.request_b_new_value / 100).toFixed(2)}å…ƒ
            `;
        }
        
        // é˜¶æ®µ3ï¼šAå†™å…¥
        function stage3_AWrite() {
            document.getElementById('stepA2').classList.remove('active');
            document.getElementById('stepA3').classList.add('active');
            document.getElementById('bubbleA').className = 'data-bubble writing';
            document.getElementById('bubbleA').innerHTML = `
                <strong>ğŸŸ¢ å†™å…¥æˆåŠŸï¼</strong><br>
                å†™å…¥å€¼ = ${(conflictData.request_a_write_value / 100).toFixed(2)}å…ƒ
            `;
            
            // æ•°æ®åº“æ›´æ–°
            const dbElement = document.getElementById('dbValue');
            dbElement.className = 'db-value updating';
            dbElement.textContent = (conflictData.db_after_a / 100).toFixed(2);
        }
        
        // é˜¶æ®µ4ï¼šBå†™å…¥ï¼ˆå†²çªï¼ï¼‰
        function stage4_BWrite() {
            document.getElementById('stepB2').classList.remove('active');
            document.getElementById('stepB3').classList.add('active');
            
            // æ˜¾ç¤ºè­¦å‘Š
            document.getElementById('warningContent').innerHTML = `
                <strong>âš ï¸ Stale Data æ£€æµ‹ï¼</strong><br><br>
                Bçš„è®¡ç®—åŸºå‡†: ${(conflictData.request_b_read_value / 100).toFixed(2)}å…ƒ<br>
                DBå½“å‰å®é™…å€¼: ${(conflictData.db_after_a / 100).toFixed(2)}å…ƒ<br>
                <span style="color: #991b1b; font-weight: bold;">åŸºå‡†å·²è¿‡æœŸï¼è¦†ç›–å³å°†å‘ç”Ÿï¼</span>
            `;
            document.getElementById('warningBox').classList.add('show');
            
            // Bå†™å…¥
            document.getElementById('bubbleB').className = 'data-bubble stale';
            document.getElementById('bubbleB').innerHTML = `
                <strong>âŒ è¦†ç›–å†™å…¥ï¼</strong><br>
                å†™å…¥å€¼ = ${(conflictData.request_b_write_value / 100).toFixed(2)}å…ƒ<br>
                <span style="font-size: 0.9rem;">ï¼ˆè¦†ç›–äº†Açš„ç»“æœï¼‰</span>
            `;
            
            // æ•°æ®åº“å†²çª
            const dbElement = document.getElementById('dbValue');
            dbElement.className = 'db-value conflict';
            dbElement.textContent = (conflictData.db_after_b / 100).toFixed(2);
        }
        
        // æ›´æ–°æ“ä½œå†å²
        function updateHistory(stage) {
            const baseTime = Math.min(conflictData.request_a_read_time, conflictData.request_b_read_time);
            
            let historyA = '';
            let historyB = '';
            
            if (stage >= 1) {
                historyA += `<div class="history-item">
                    <strong>Step 1:</strong> è¯»å–ä½™é¢ ${(conflictData.request_a_read_value / 100).toFixed(2)}å…ƒ<br>
                    <small>æ—¶é—´: ${formatTimestamp(conflictData.request_a_read_time)}</small>
                </div>`;
                
                historyB += `<div class="history-item">
                    <strong>Step 1:</strong> è¯»å–ä½™é¢ ${(conflictData.request_b_read_value / 100).toFixed(2)}å…ƒ<br>
                    <small>æ—¶é—´: ${formatTimestamp(conflictData.request_b_read_time)}</small>
                </div>`;
            }
            
            if (stage >= 2) {
                historyA += `<div class="history-item">
                    <strong>Step 2:</strong> è®¡ç®—æ–°å€¼ ${(conflictData.request_a_new_value / 100).toFixed(2)}å…ƒ<br>
                    <small>è€—æ—¶: ${getRelativeTime(conflictData.request_a_calc_end, conflictData.request_a_calc_start)}</small>
                </div>`;
                
                historyB += `<div class="history-item">
                    <strong>Step 2:</strong> è®¡ç®—æ–°å€¼ ${(conflictData.request_b_new_value / 100).toFixed(2)}å…ƒ<br>
                    <small>è€—æ—¶: ${getRelativeTime(conflictData.request_b_calc_end, conflictData.request_b_calc_start)}</small>
                </div>`;
            }
            
            if (stage >= 3) {
                historyA += `<div class="history-item">
                    <strong>Step 3:</strong> å†™å…¥æˆåŠŸ ${(conflictData.request_a_write_value / 100).toFixed(2)}å…ƒ<br>
                    <small>æ—¶é—´: ${formatTimestamp(conflictData.request_a_write_time)}</small>
                </div>`;
            }
            
            if (stage >= 4) {
                historyB += `<div class="history-item" style="border-left-color: #ef4444; background: #fee2e2;">
                    <strong>Step 3:</strong> âŒ è¦†ç›–å†™å…¥ ${(conflictData.request_b_write_value / 100).toFixed(2)}å…ƒ<br>
                    <small>æ—¶é—´: ${formatTimestamp(conflictData.request_b_write_time)}</small>
                </div>`;
            }
            
            document.getElementById('historyListA').innerHTML = historyA || '<p style="color: #999;">æš‚æ— æ“ä½œ</p>';
            document.getElementById('historyListB').innerHTML = historyB || '<p style="color: #999;">æš‚æ— æ“ä½œ</p>';
        }
        
        // æ¸…é™¤å†²çªæ•°æ®
        async function clearConflict() {
            try {
                await fetch('/api/conflict/clear', { method: 'POST' });
                conflictData = null;
                document.getElementById('conflictSummary').style.display = 'none';
                document.getElementById('warningBox').classList.remove('show');
                resetAnimation();
                showStatus('âœ… æ•°æ®å·²æ¸…é™¤', 'success');
            } catch (error) {
                showStatus('âŒ æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                statusEl.style.background = '#d1fae5';
                statusEl.style.color = '#065f46';
            } else if (type === 'warning') {
                statusEl.style.background = '#fef3c7';
                statusEl.style.color = '#92400e';
            } else {
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#991b1b';
            }
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨åŠ è½½æ•°æ®
        window.onload = () => {
            loadConflict();
        };
    </script>
</body>
</html>
