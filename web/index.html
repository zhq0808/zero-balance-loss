<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero Balance Loss - å¹¶å‘ä½™é¢ä¸¢å¤±æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            grid-column: span 2;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }
        
        .control-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ç»Ÿè®¡é¢æ¿ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* ä½™é¢æ°´ä½å›¾ */
        .balance-chart {
            height: 300px;
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* æ—¶åºè¿½è¸ª */
        .trace-container {
            grid-column: span 2;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .trace-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .trace-item {
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 80px 100px 1fr 150px;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .trace-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .trace-item.conflict {
            border-left-color: #ef4444;
            background: #fee;
        }
        
        .trace-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
        }
        
        .trace-step {
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .trace-step.step-1 {
            background: #3b82f6;
        }
        
        .trace-step.step-2 {
            background: #ef4444;
        }
        
        .trace-step.step-3 {
            background: #10b981;
        }
        
        .trace-details {
            color: #555;
        }
        
        .trace-time {
            color: #999;
            font-size: 0.85rem;
            text-align: right;
        }
        
        .anomaly {
            color: #ef4444;
            font-weight: bold;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            margin-top: 15px;
        }
        
        .status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status.attacking {
            background: #fef3c7;
            color: #92400e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Zero Balance Loss</h1>
            <p>å¹¶å‘åœºæ™¯ä¸‹çš„ä½™é¢æ›´æ–°ä¸¢å¤±æ¼”ç¤º - Level 1: æ— é”å®ç°</p>
        </div>
        
        <div class="dashboard">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="card control-panel">
                <h2 class="card-title">ğŸ® æ§åˆ¶å°</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>åˆå§‹ä½™é¢ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="initialBalance" value="1000" min="0">
                    </div>
                    <div class="control-group">
                        <label>å¹¶å‘æ•°</label>
                        <input type="number" id="concurrency" value="50" min="1" max="500">
                    </div>
                    <div class="control-group">
                        <label>æ¯æ¬¡æ‰£æ¬¾ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="deductAmount" value="10" min="1">
                    </div>
                    <div class="control-group">
                        <label>æ¯ä¸ªåç¨‹è¯·æ±‚æ¬¡æ•°</label>
                        <input type="number" id="requestsPerRoutine" value="10" min="1" max="100">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="resetBalance()">é‡ç½®ä½™é¢</button>
                    <button class="btn-primary" id="attackBtn" onclick="startAttack()">ğŸš€ å‘èµ·å¹¶å‘æ”»å‡»</button>
                    <button class="btn-warning hidden" id="stopBtn" onclick="stopAttack()">â¹ï¸ åœæ­¢æ”»å‡»</button>
                    <button class="btn-danger" onclick="clearTraces()">æ¸…ç©ºè®°å½•</button>
                </div>
                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn-warning" id="monitorBtn" onclick="toggleMonitoring()">â¸ï¸ æš‚åœç›‘æ§</button>
                </div>
                <div id="status" class="status disconnected">è¿æ¥ä¸­...</div>
            </div>
            
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="card">
                <h2 class="card-title">ğŸ“Š è¯·æ±‚ç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalRequests">0</div>
                        <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="successCount">0</div>
                        <div class="stat-label">æˆåŠŸæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="failureCount">0</div>
                        <div class="stat-label">å¤±è´¥æ•°</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>å½“å‰ä½™é¢ï¼š</span>
                        <strong id="currentBalance">0.00 å…ƒ</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>ç†è®ºä½™é¢ï¼š</span>
                        <strong id="expectedBalance">0.00 å…ƒ</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ä¸¢å¤±é‡‘é¢ï¼š</span>
                        <strong id="lostAmount" class="anomaly">0.00 å…ƒ</strong>
                    </div>
                </div>
            </div>
            
            <!-- ä½™é¢æ°´ä½å›¾ -->
            <div class="card">
                <h2 class="card-title">ğŸ“ˆ ä½™é¢æ°´ä½å®æ—¶ç›‘æ§</h2>
                <div class="balance-chart">
                    <canvas id="balanceChart"></canvas>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px; font-size: 0.9rem;">
                    <div><span style="color: #3b82f6;">â—</span> å®é™…ä½™é¢</div>
                    <div><span style="color: #ef4444;">â—</span> ç†è®ºä½™é¢</div>
                </div>
            </div>
            
            <!-- æ—¶åºè¿½è¸ª -->
            <div class="card trace-container">
                <h2 class="card-title">ğŸ” å¹¶å‘å†²çªæ—¶åºè¿½è¸ª</h2>
                <div class="trace-list" id="traceList">
                    <div style="text-align: center; padding: 40px; color: #999;">
                        ç­‰å¾…å¹¶å‘è¯·æ±‚...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let ws = null;                      // WebSocketè¿æ¥å¯¹è±¡
        let chart = null;                   // Chart.jså›¾è¡¨å®ä¾‹
        let initialBalanceValue = 100000;   // åˆå§‹ä½™é¢ï¼ˆåˆ†ï¼‰
        let expectedBalance = 100000;       // ç†è®ºä½™é¢ï¼ˆåˆ†ï¼‰
        let isAttacking = false;            // æ˜¯å¦æ­£åœ¨æ”»å‡»
        let shouldStopAttack = false;       // åœæ­¢æ”»å‡»æ ‡å¿—
        let isMonitoringPaused = false;     // ç›‘æ§æ˜¯å¦æš‚åœ
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å®é™…ä½™é¢',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'ç†è®ºä½™é¢',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // è¿æ¥WebSocket
        function connectWebSocket() {
            ws = new WebSocket('ws://' + window.location.host + '/ws');
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'âœ“ å·²è¿æ¥';
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'âœ— è¿æ¥æ–­å¼€';
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
        }
        
        // ==================== WebSocketæ¶ˆæ¯å¤„ç† ====================
        /**
         * å¤„ç†ä»æœåŠ¡å™¨æ¥æ”¶çš„WebSocketæ¶ˆæ¯
         * @param {Object} msg - æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«typeå’Œdataå­—æ®µ
         */
        function handleMessage(msg) {
            switch(msg.type) {
                case 'init':
                    // åˆå§‹åŒ–ï¼šè¿æ¥å»ºç«‹æ—¶æ¥æ”¶åˆå§‹æ•°æ®
                    updateBalance(msg.data.balance);
                    updateStats(msg.data.stats);
                    break;
                    
                case 'balance_update':
                    // ä½™é¢æ›´æ–°ï¼šå®šæœŸæ¥æ”¶çš„å®æ—¶æ•°æ®
                    updateBalance(msg.data.balance);
                    updateStats(msg.data.stats);
                    updateChart(msg.data.balance);
                    break;
                    
                case 'trace':
                    // è¿½è¸ªäº‹ä»¶ï¼šæ¯æ¬¡æ‰£æ¬¾æ“ä½œçš„æ­¥éª¤è®°å½•
                    addTrace(msg.data);
                    break;
                    
                case 'reset':
                    // é‡ç½®äº‹ä»¶ï¼šä½™é¢é‡ç½®ï¼Œåˆ·æ–°é¡µé¢
                    location.reload();
                    break;
                    
                case 'monitoring_status':
                    // ç›‘æ§çŠ¶æ€å˜æ›´ï¼šæ›´æ–°ç›‘æ§æŒ‰é’®çŠ¶æ€
                    updateMonitoringButton(msg.data.status);
                    break;
            }
        }
        
        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        function updateBalance(balance) {
            document.getElementById('currentBalance').textContent = (balance / 100).toFixed(2) + ' å…ƒ';
            const lost = (balance - expectedBalance) / 100;
            document.getElementById('lostAmount').textContent = lost.toFixed(2) + ' å…ƒ';
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats(stats) {
            document.getElementById('totalRequests').textContent = stats.total_requests;
            document.getElementById('successCount').textContent = stats.success_count;
            document.getElementById('failureCount').textContent = stats.failure_count;
            
            // è®¡ç®—ç†è®ºä½™é¢
            const deductAmount = parseInt(document.getElementById('deductAmount').value) * 100;
            expectedBalance = initialBalanceValue - (stats.success_count * deductAmount);
            document.getElementById('expectedBalance').textContent = (expectedBalance / 100).toFixed(2) + ' å…ƒ';
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(balance) {
            const now = new Date().toLocaleTimeString();
            
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(balance / 100);
            chart.data.datasets[1].data.push(expectedBalance / 100);
            chart.update('none');
        }
        
        // æ·»åŠ è¿½è¸ªè®°å½•
        function addTrace(trace) {
            const traceList = document.getElementById('traceList');
            
            // æ¸…ç©ºæç¤º
            if (traceList.children[0]?.textContent.includes('ç­‰å¾…')) {
                traceList.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'trace-item';
            
            const stepClass = `step-${trace.step}`;
            const time = new Date(trace.timestamp).toLocaleTimeString();
            
            item.innerHTML = `
                <div class="trace-id">${trace.request_id}</div>
                <div class="trace-step ${stepClass}">${trace.step_name}</div>
                <div class="trace-details">
                    ä½™é¢: ${(trace.balance / 100).toFixed(2)}å…ƒ 
                    ${trace.new_balance ? `â†’ ${(trace.new_balance / 100).toFixed(2)}å…ƒ` : ''}
                    (æ‰£: ${(trace.amount / 100).toFixed(2)}å…ƒ)
                </div>
                <div class="trace-time">${time}</div>
            `;
            
            traceList.insertBefore(item, traceList.firstChild);
            
            // æœ€å¤šä¿ç•™100æ¡
            if (traceList.children.length > 100) {
                traceList.removeChild(traceList.lastChild);
            }
        }
        
        // é‡ç½®ä½™é¢
        async function resetBalance() {
            const balance = parseInt(document.getElementById('initialBalance').value) * 100;
            initialBalanceValue = balance;
            expectedBalance = balance;
            
            try {
                const response = await fetch('/api/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 1, balance: balance })
                });
                
                if (response.ok) {
                    clearTraces();
                    chart.data.labels = [];
                    chart.data.datasets[0].data = [];
                    chart.data.datasets[1].data = [];
                    chart.update();
                }
            } catch (error) {
                console.error('Reset failed:', error);
            }
        }
        
        // å‘èµ·æ”»å‡»
        async function startAttack() {
            if (isAttacking) return;
            
            isAttacking = true;
            shouldStopAttack = false;
            const attackBtn = document.getElementById('attackBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            attackBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            
            document.getElementById('status').className = 'status attacking';
            document.getElementById('status').textContent = 'âš¡ æ”»å‡»è¿›è¡Œä¸­...';
            
            const concurrency = parseInt(document.getElementById('concurrency').value);
            const amount = parseInt(document.getElementById('deductAmount').value) * 100;
            const requests = parseInt(document.getElementById('requestsPerRoutine').value);
            
            const promises = [];
            for (let i = 0; i < concurrency; i++) {
                promises.push(sendConcurrentRequests(amount, requests));
            }
            
            await Promise.all(promises);
            
            isAttacking = false;
            attackBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            
            document.getElementById('status').className = 'status connected';
            document.getElementById('status').textContent = shouldStopAttack ? 'â¹ï¸ å·²åœæ­¢' : 'âœ“ å·²è¿æ¥';
        }
        
        // åœæ­¢æ”»å‡»
        function stopAttack() {
            shouldStopAttack = true;
            document.getElementById('status').textContent = 'â¹ï¸ æ­£åœ¨åœæ­¢...';
        }
        
        // å‘é€å¹¶å‘è¯·æ±‚
        async function sendConcurrentRequests(amount, count) {
            for (let i = 0; i < count; i++) {
                if (shouldStopAttack) {
                    break;
                }
                
                try {
                    await fetch('/api/deduct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: 1, amount: amount })
                    });
                } catch (error) {
                    console.error('Request failed:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 10));
            }
        }
        
        // ==================== ç›‘æ§æ§åˆ¶ ====================
        /**
         * åˆ‡æ¢ç›‘æ§çŠ¶æ€ï¼ˆæš‚åœ/æ¢å¤ï¼‰
         * æš‚åœæ—¶åœæ­¢åå°SQLæŸ¥è¯¢ï¼Œæ¢å¤æ—¶ç»§ç»­æŸ¥è¯¢
         */
        async function toggleMonitoring() {
            const btn = document.getElementById('monitorBtn');
            btn.disabled = true;
            
            try {
                // æ ¹æ®å½“å‰çŠ¶æ€è°ƒç”¨å¯¹åº”çš„API
                const endpoint = isMonitoringPaused ? '/api/monitoring/resume' : '/api/monitoring/pause';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // æ›´æ–°æœ¬åœ°çŠ¶æ€å’ŒæŒ‰é’®æ˜¾ç¤º
                    updateMonitoringButton(result.data.status);
                } else {
                    console.error('ç›‘æ§æ§åˆ¶å¤±è´¥');
                }
            } catch (error) {
                console.error('ç›‘æ§æ§åˆ¶è¯·æ±‚å¤±è´¥:', error);
            } finally {
                btn.disabled = false;
            }
        }
        
        /**
         * æ›´æ–°ç›‘æ§æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
         * @param {string} status - ç›‘æ§çŠ¶æ€ï¼š'running' æˆ– 'paused'
         */
        function updateMonitoringButton(status) {
            const btn = document.getElementById('monitorBtn');
            isMonitoringPaused = (status === 'paused');
            
            if (isMonitoringPaused) {
                // æš‚åœçŠ¶æ€ï¼šæ˜¾ç¤ºæ¢å¤æŒ‰é’®
                btn.textContent = 'â–¶ï¸ æ¢å¤ç›‘æ§';
                btn.className = 'btn-success';
                console.log('âœ… ç›‘æ§å·²æš‚åœï¼ŒSQLæŸ¥è¯¢å·²åœæ­¢');
            } else {
                // è¿è¡ŒçŠ¶æ€ï¼šæ˜¾ç¤ºæš‚åœæŒ‰é’®
                btn.textContent = 'â¸ï¸ æš‚åœç›‘æ§';
                btn.className = 'btn-warning';
                console.log('âœ… ç›‘æ§å·²æ¢å¤ï¼ŒSQLæŸ¥è¯¢å·²å¯åŠ¨');
            }
        }
        
        // ==================== æ¸…ç©ºè¿½è¸ª ====================
        /**
         * æ¸…ç©ºæ—¶åºè¿½è¸ªåˆ—è¡¨
         */
        function clearTraces() {
            document.getElementById('traceList').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    ç­‰å¾…å¹¶å‘è¯·æ±‚...
                </div>
            `;
        }
        
        // ==================== åˆå§‹åŒ– ====================
        /**
         * é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–æ“ä½œ
         */
        window.onload = async () => {
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // å»ºç«‹WebSocketè¿æ¥
            connectWebSocket();
            
            // è·å–å¹¶è®¾ç½®åˆå§‹ç›‘æ§çŠ¶æ€
            try {
                const response = await fetch('/api/monitoring/status');
                if (response.ok) {
                    const result = await response.json();
                    updateMonitoringButton(result.data.status);
                }
            } catch (error) {
                console.error('è·å–ç›‘æ§çŠ¶æ€å¤±è´¥:', error);
            }
        };
    </script>
</body>
</html>
