<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero Balance Loss - å¹¶å‘ä½™é¢ä¸¢å¤±æ¼”ç¤º</title>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            grid-column: span 2;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }
        
        .control-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        
        .btn-info:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* æ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
        .time-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .time-selector input[type="datetime-local"] {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .time-selector input[type="datetime-local"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .mode-indicator {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            text-align: center;
            margin-top: 10px;
        }
        
        .mode-indicator.realtime {
            background: #d1fae5;
            color: #065f46;
        }
        
        .mode-indicator.history {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* ä»£ç æ§åˆ¶å°æ ·å¼ */
        .code-console {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .console-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .lock-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toggle-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .3s;
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #10b981;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .lock-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .lock-status.unlocked {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .lock-status.locked {
            background: #d1fae5;
            color: #065f46;
        }
        
        .lock-icon {
            font-size: 1rem;
        }
        
        .code-display-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .code-block-wrapper {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .code-block-wrapper.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .code-block-header {
            background: #f3f4f6;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .code-block-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .code-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .code-badge.unlocked {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .code-badge.locked {
            background: #d1fae5;
            color: #065f46;
        }
        
        .code-block-content {
            position: relative;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .code-block-content pre {
            margin: 0;
            padding: 15px;
            background: #282c34;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        
        .code-block-content code {
            font-family: 'Courier New', Consolas, Monaco, monospace;
        }
        
        .code-highlight-line {
            background-color: rgba(255, 255, 0, 0.1);
            display: block;
            margin: 0 -15px;
            padding: 0 15px;
        }
        
        /* ç»Ÿè®¡é¢æ¿ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* ä½™é¢æ°´ä½å›¾ */
        .balance-chart {
            height: 300px;
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* æ—¶åºè¿½è¸ª */
        .trace-container {
            grid-column: span 2;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .trace-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .trace-item {
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 80px 100px 1fr 150px;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .trace-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .trace-item.conflict {
            border-left-color: #ef4444;
            background: #fee;
        }
        
        .trace-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
        }
        
        .trace-step {
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .trace-step.step-1 {
            background: #3b82f6;
        }
        
        .trace-step.step-2 {
            background: #ef4444;
        }
        
        .trace-step.step-3 {
            background: #10b981;
        }
        
        .trace-details {
            color: #555;
        }
        
        .trace-time {
            color: #999;
            font-size: 0.85rem;
            text-align: right;
        }
        
        .anomaly {
            color: #ef4444;
            font-weight: bold;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            margin-top: 15px;
        }
        
        .status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status.attacking {
            background: #fef3c7;
            color: #92400e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Zero Balance Loss</h1>
            <p>å¹¶å‘åœºæ™¯ä¸‹çš„ä½™é¢æ›´æ–°ä¸¢å¤±æ¼”ç¤º - Level 1: æ— é”å®ç°</p>
        </div>
        
        <div class="dashboard">
            <!-- ä»£ç æ§åˆ¶å° -->
            <div class="code-console" style="grid-column: span 3;">
                <div class="console-header">
                    <h2 class="console-title">ğŸ’» äº¤äº’å¼ä»£ç æ§åˆ¶å°</h2>
                    <div class="lock-toggle-container">
                        <span class="toggle-label">åŠ é”æ¨¡å¼</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="lockToggle" onchange="toggleLockMode()">
                            <span class="toggle-slider"></span>
                        </label>
                        <div id="lockStatus" class="lock-status unlocked">
                            <span class="lock-icon">ğŸ”“</span>
                            <span>æ— é”</span>
                        </div>
                    </div>
                </div>
                <div class="code-display-area">
                    <!-- æ— é”ç‰ˆæœ¬ä»£ç  -->
                    <div class="code-block-wrapper active" id="unlockedCodeBlock">
                        <div class="code-block-header">
                            <span class="code-block-title">æ— é”ç‰ˆæœ¬ (å­˜åœ¨å¹¶å‘é—®é¢˜)</span>
                            <span class="code-badge unlocked">UNLOCKED</span>
                        </div>
                        <div class="code-block-content">
                            <pre><code class="language-go">func (s *AccountService) DeductBalance(
    req *model.DeductRequest,
    requestID string) *model.DeductResponse {
    
    db := config.GetDB()
    
    // Step 1: è¯»å–å½“å‰ä½™é¢ (æ— é”ä¿æŠ¤)
    var account model.Account
    if err := db.Where("user_id = ?", req.UserID).
        First(&account).Error; err != nil {
        return &model.DeductResponse{
            Success: false,
            Message: "è´¦æˆ·ä¸å­˜åœ¨",
        }
    }
    
    // âš ï¸ æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†è€—æ—¶ï¼Œæ”¾å¤§å¹¶å‘çª—å£
    time.Sleep(10 * time.Millisecond)
    
    // Step 2: æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    if account.Balance < req.Amount {
        return &model.DeductResponse{
            Success: false,
            Message: "ä½™é¢ä¸è¶³",
        }
    }
    
    // Step 3: æ‰£å‡ä½™é¢ (å­˜åœ¨ç«æ€æ¡ä»¶)
    account.Balance -= req.Amount
    if err := db.Save(&account).Error; err != nil {
        return &model.DeductResponse{
            Success: false,
            Message: "æ‰£æ¬¾å¤±è´¥",
        }
    }
    
    return &model.DeductResponse{
        Success:        true,
        Message:        "æ‰£æ¬¾æˆåŠŸ",
        CurrentBalance: account.Balance,
    }
}</code></pre>
                        </div>
                    </div>
                    
                    <!-- åŠ é”ç‰ˆæœ¬ä»£ç  -->
                    <div class="code-block-wrapper" id="lockedCodeBlock">
                        <div class="code-block-header">
                            <span class="code-block-title">åŠ é”ç‰ˆæœ¬ (ä½¿ç”¨äº’æ–¥é”)</span>
                            <span class="code-badge locked">LOCKED</span>
                        </div>
                        <div class="code-block-content">
                            <pre><code class="language-go">var accountMutex sync.Mutex

func (s *AccountService) DeductBalanceWithLock(
    req *model.DeductRequest,
    requestID string) *model.DeductResponse {
    
    // ğŸ”’ è·å–äº’æ–¥é”ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªåç¨‹æ‰§è¡Œ
    accountMutex.Lock()
    defer accountMutex.Unlock()
    
    db := config.GetDB()
    
    // Step 1: è¯»å–å½“å‰ä½™é¢ (å·²åŠ é”ä¿æŠ¤)
    var account model.Account
    if err := db.Where("user_id = ?", req.UserID).
        First(&account).Error; err != nil {
        return &model.DeductResponse{
            Success: false,
            Message: "è´¦æˆ·ä¸å­˜åœ¨",
        }
    }
    
    // â±ï¸ æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†è€—æ—¶
    time.Sleep(10 * time.Millisecond)
    
    // Step 2: æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    if account.Balance < req.Amount {
        return &model.DeductResponse{
            Success: false,
            Message: "ä½™é¢ä¸è¶³",
        }
    }
    
    // Step 3: æ‰£å‡ä½™é¢ (çº¿ç¨‹å®‰å…¨)
    account.Balance -= req.Amount
    if err := db.Save(&account).Error; err != nil {
        return &model.DeductResponse{
            Success: false,
            Message: "æ‰£æ¬¾å¤±è´¥",
        }
    }
    
    return &model.DeductResponse{
        Success:        true,
        Message:        "æ‰£æ¬¾æˆåŠŸ",
        CurrentBalance: account.Balance,
    }
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="card control-panel">
                <h2 class="card-title">ğŸ® æ§åˆ¶å°</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>åˆå§‹ä½™é¢ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="initialBalance" value="1000" min="0">
                    </div>
                    <div class="control-group">
                        <label>å¹¶å‘æ•°</label>
                        <input type="number" id="concurrency" value="50" min="1" max="500">
                    </div>
                    <div class="control-group">
                        <label>æ¯æ¬¡æ‰£æ¬¾ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="deductAmount" value="10" min="1">
                    </div>
                    <div class="control-group">
                        <label>æ¯ä¸ªåç¨‹è¯·æ±‚æ¬¡æ•°</label>
                        <input type="number" id="requestsPerRoutine" value="10" min="1" max="100">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="resetBalance()">é‡ç½®ä½™é¢</button>
                    <button class="btn-primary" id="attackBtn" onclick="startAttack()">ğŸš€ å‘èµ·å¹¶å‘æ”»å‡»</button>
                    <button class="btn-warning hidden" id="stopBtn" onclick="stopAttack()">â¹ï¸ åœæ­¢æ”»å‡»</button>
                    <button class="btn-danger" onclick="clearTraces()">æ¸…ç©ºè®°å½•</button>
                </div>
                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn-warning" id="monitorBtn" onclick="toggleMonitoring()">â¸ï¸ æš‚åœç›‘æ§</button>
                </div>
                <div id="status" class="status disconnected">è¿æ¥ä¸­...</div>
            </div>
            
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="card">
                <h2 class="card-title">ğŸ“Š è¯·æ±‚ç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalRequests">0</div>
                        <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="successCount">0</div>
                        <div class="stat-label">æˆåŠŸæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="failureCount">0</div>
                        <div class="stat-label">å¤±è´¥æ•°</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>å½“å‰ä½™é¢ï¼š</span>
                        <strong id="currentBalance">0.00 å…ƒ</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>ç†è®ºä½™é¢ï¼š</span>
                        <strong id="expectedBalance">0.00 å…ƒ</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ä¸¢å¤±é‡‘é¢ï¼š</span>
                        <strong id="lostAmount" class="anomaly">0.00 å…ƒ</strong>
                    </div>
                </div>
            </div>
            
            <!-- ä½™é¢æ°´ä½å›¾ -->
            <div class="card">
                <h2 class="card-title">ğŸ“ˆ ä½™é¢æ°´ä½å®æ—¶ç›‘æ§</h2>
                
                <!-- å†å²æŸ¥çœ‹æ§åˆ¶ -->
                <div class="time-selector" id="historyControls">
                    <input type="datetime-local" id="startTime" />
                    <input type="datetime-local" id="endTime" />
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-info" style="flex: 1;" onclick="viewHistory()">ğŸ“… æŸ¥çœ‹å†å²</button>
                        <button class="btn-success hidden" id="realtimeBtn" style="flex: 1;" onclick="switchToRealtime()">ğŸ”´ è¿”å›å®æ—¶</button>
                    </div>
                </div>
                
                <!-- æ¨¡å¼æŒ‡ç¤ºå™¨ -->
                <div id="modeIndicator" class="mode-indicator realtime">
                    ğŸ”´ å®æ—¶æ¨¡å¼
                </div>
                
                <div class="balance-chart">
                    <canvas id="balanceChart"></canvas>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px; font-size: 0.9rem;">
                    <div><span style="color: #3b82f6;">â—</span> å®é™…ä½™é¢</div>
                    <div><span style="color: #ef4444;">â—</span> ç†è®ºä½™é¢</div>
                </div>
            </div>
            
            <!-- æ—¶åºè¿½è¸ª -->
            <div class="card trace-container">
                <h2 class="card-title">ğŸ” å¹¶å‘å†²çªæ—¶åºè¿½è¸ª</h2>
                <div class="trace-list" id="traceList">
                    <div style="text-align: center; padding: 40px; color: #999;">
                        ç­‰å¾…å¹¶å‘è¯·æ±‚...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let ws = null;                      // WebSocketè¿æ¥å¯¹è±¡
        let chart = null;                   // Chart.jså›¾è¡¨å®ä¾‹
        let initialBalanceValue = 100000;   // åˆå§‹ä½™é¢ï¼ˆåˆ†ï¼‰
        let expectedBalance = 100000;       // ç†è®ºä½™é¢ï¼ˆåˆ†ï¼‰
        let isAttacking = false;            // æ˜¯å¦æ­£åœ¨æ”»å‡»
        let shouldStopAttack = false;       // åœæ­¢æ”»å‡»æ ‡å¿—
        let isMonitoringPaused = false;     // ç›‘æ§æ˜¯å¦æš‚åœ
        let isHistoryMode = false;          // æ˜¯å¦å¤„äºå†å²æŸ¥çœ‹æ¨¡å¼
        
        // ==================== å›¾è¡¨åˆå§‹åŒ– ====================
        /**
         * åˆå§‹åŒ–Chart.jså›¾è¡¨
         */
        function initChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å®é™…ä½™é¢',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'ç†è®ºä½™é¢',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // è¿æ¥WebSocket
        function connectWebSocket() {
            ws = new WebSocket('ws://' + window.location.host + '/ws');
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'âœ“ å·²è¿æ¥';
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'âœ— è¿æ¥æ–­å¼€';
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
        }
        
        // ==================== WebSocketæ¶ˆæ¯å¤„ç† ====================
        /**
         * å¤„ç†ä»æœåŠ¡å™¨æ¥æ”¶çš„WebSocketæ¶ˆæ¯
         * @param {Object} msg - æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«typeå’Œdataå­—æ®µ
         */
        function handleMessage(msg) {
            switch(msg.type) {
                case 'init':
                    // åˆå§‹åŒ–ï¼šè¿æ¥å»ºç«‹æ—¶æ¥æ”¶åˆå§‹æ•°æ®
                    updateBalance(msg.data.balance);
                    updateStats(msg.data.stats);
                    break;
                    
                case 'balance_update':
                    // ä½™é¢æ›´æ–°ï¼šå®šæœŸæ¥æ”¶çš„å®æ—¶æ•°æ®
                    // å¦‚æœå¤„äºå†å²æ¨¡å¼ï¼Œå¿½ç•¥å®æ—¶æ›´æ–°
                    if (!isHistoryMode) {
                        updateBalance(msg.data.balance);
                        updateStats(msg.data.stats);
                        updateChart(msg.data.balance);
                    }
                    break;
                    
                case 'trace':
                    // è¿½è¸ªäº‹ä»¶ï¼šæ¯æ¬¡æ‰£æ¬¾æ“ä½œçš„æ­¥éª¤è®°å½•
                    addTrace(msg.data);
                    break;
                    
                case 'reset':
                    // é‡ç½®äº‹ä»¶ï¼šä½™é¢é‡ç½®ï¼Œåˆ·æ–°é¡µé¢
                    location.reload();
                    break;
                    
                case 'monitoring_status':
                    // ç›‘æ§çŠ¶æ€å˜æ›´ï¼šæ›´æ–°ç›‘æ§æŒ‰é’®çŠ¶æ€
                    updateMonitoringButton(msg.data.status);
                    break;
                    
                case 'mode_changed':
                    // æ¨¡å¼åˆ‡æ¢ï¼šæœåŠ¡ç«¯é€šçŸ¥æ¨¡å¼å·²åˆ‡æ¢
                    updateLockModeUI(msg.data.use_lock);
                    break;
            }
        }
        
        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        function updateBalance(balance) {
            document.getElementById('currentBalance').textContent = (balance / 100).toFixed(2) + ' å…ƒ';
            const lost = (balance - expectedBalance) / 100;
            document.getElementById('lostAmount').textContent = lost.toFixed(2) + ' å…ƒ';
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats(stats) {
            document.getElementById('totalRequests').textContent = stats.total_requests;
            document.getElementById('successCount').textContent = stats.success_count;
            document.getElementById('failureCount').textContent = stats.failure_count;
            
            // è®¡ç®—ç†è®ºä½™é¢
            const deductAmount = parseInt(document.getElementById('deductAmount').value) * 100;
            expectedBalance = initialBalanceValue - (stats.success_count * deductAmount);
            document.getElementById('expectedBalance').textContent = (expectedBalance / 100).toFixed(2) + ' å…ƒ';
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(balance) {
            const now = new Date().toLocaleTimeString();
            
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(balance / 100);
            chart.data.datasets[1].data.push(expectedBalance / 100);
            chart.update('none');
        }
        
        // æ·»åŠ è¿½è¸ªè®°å½•
        function addTrace(trace) {
            const traceList = document.getElementById('traceList');
            
            // æ¸…ç©ºæç¤º
            if (traceList.children[0]?.textContent.includes('ç­‰å¾…')) {
                traceList.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'trace-item';
            
            const stepClass = `step-${trace.step}`;
            const time = new Date(trace.timestamp).toLocaleTimeString();
            
            item.innerHTML = `
                <div class="trace-id">${trace.request_id}</div>
                <div class="trace-step ${stepClass}">${trace.step_name}</div>
                <div class="trace-details">
                    ä½™é¢: ${(trace.balance / 100).toFixed(2)}å…ƒ 
                    ${trace.new_balance ? `â†’ ${(trace.new_balance / 100).toFixed(2)}å…ƒ` : ''}
                    (æ‰£: ${(trace.amount / 100).toFixed(2)}å…ƒ)
                </div>
                <div class="trace-time">${time}</div>
            `;
            
            traceList.insertBefore(item, traceList.firstChild);
            
            // æœ€å¤šä¿ç•™100æ¡
            if (traceList.children.length > 100) {
                traceList.removeChild(traceList.lastChild);
            }
        }
        
        // é‡ç½®ä½™é¢
        async function resetBalance() {
            const balance = parseInt(document.getElementById('initialBalance').value) * 100;
            initialBalanceValue = balance;
            expectedBalance = balance;
            
            try {
                const response = await fetch('/api/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 1, balance: balance })
                });
                
                if (response.ok) {
                    clearTraces();
                    chart.data.labels = [];
                    chart.data.datasets[0].data = [];
                    chart.data.datasets[1].data = [];
                    chart.update();
                }
            } catch (error) {
                console.error('Reset failed:', error);
            }
        }
        
        // å‘èµ·æ”»å‡»
        async function startAttack() {
            if (isAttacking) return;
            
            isAttacking = true;
            shouldStopAttack = false;
            const attackBtn = document.getElementById('attackBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            attackBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            
            document.getElementById('status').className = 'status attacking';
            document.getElementById('status').textContent = 'âš¡ æ”»å‡»è¿›è¡Œä¸­...';
            
            const concurrency = parseInt(document.getElementById('concurrency').value);
            const amount = parseInt(document.getElementById('deductAmount').value) * 100;
            const requests = parseInt(document.getElementById('requestsPerRoutine').value);
            
            const promises = [];
            for (let i = 0; i < concurrency; i++) {
                promises.push(sendConcurrentRequests(amount, requests));
            }
            
            await Promise.all(promises);
            
            isAttacking = false;
            attackBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            
            document.getElementById('status').className = 'status connected';
            document.getElementById('status').textContent = shouldStopAttack ? 'â¹ï¸ å·²åœæ­¢' : 'âœ“ å·²è¿æ¥';
        }
        
        // åœæ­¢æ”»å‡»
        function stopAttack() {
            shouldStopAttack = true;
            document.getElementById('status').textContent = 'â¹ï¸ æ­£åœ¨åœæ­¢...';
        }
        
        // å‘é€å¹¶å‘è¯·æ±‚
        async function sendConcurrentRequests(amount, count) {
            for (let i = 0; i < count; i++) {
                if (shouldStopAttack) {
                    break;
                }
                
                try {
                    await fetch('/api/deduct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: 1, amount: amount })
                    });
                } catch (error) {
                    console.error('Request failed:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 10));
            }
        }
        
        // ==================== ç›‘æ§æ§åˆ¶ ====================
        /**
         * åˆ‡æ¢ç›‘æ§çŠ¶æ€ï¼ˆæš‚åœ/æ¢å¤ï¼‰
         * æš‚åœæ—¶åœæ­¢åå°SQLæŸ¥è¯¢ï¼Œæ¢å¤æ—¶ç»§ç»­æŸ¥è¯¢
         */
        async function toggleMonitoring() {
            const btn = document.getElementById('monitorBtn');
            btn.disabled = true;
            
            try {
                // æ ¹æ®å½“å‰çŠ¶æ€è°ƒç”¨å¯¹åº”çš„API
                const endpoint = isMonitoringPaused ? '/api/monitoring/resume' : '/api/monitoring/pause';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // æ›´æ–°æœ¬åœ°çŠ¶æ€å’ŒæŒ‰é’®æ˜¾ç¤º
                    updateMonitoringButton(result.data.status);
                } else {
                    console.error('ç›‘æ§æ§åˆ¶å¤±è´¥');
                }
            } catch (error) {
                console.error('ç›‘æ§æ§åˆ¶è¯·æ±‚å¤±è´¥:', error);
            } finally {
                btn.disabled = false;
            }
        }
        
        /**
         * æ›´æ–°ç›‘æ§æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
         * @param {string} status - ç›‘æ§çŠ¶æ€ï¼š'running' æˆ– 'paused'
         */
        function updateMonitoringButton(status) {
            const btn = document.getElementById('monitorBtn');
            isMonitoringPaused = (status === 'paused');
            
            if (isMonitoringPaused) {
                // æš‚åœçŠ¶æ€ï¼šæ˜¾ç¤ºæ¢å¤æŒ‰é’®
                btn.textContent = 'â–¶ï¸ æ¢å¤ç›‘æ§';
                btn.className = 'btn-success';
                console.log('âœ… ç›‘æ§å·²æš‚åœï¼ŒSQLæŸ¥è¯¢å·²åœæ­¢');
            } else {
                // è¿è¡ŒçŠ¶æ€ï¼šæ˜¾ç¤ºæš‚åœæŒ‰é’®
                btn.textContent = 'â¸ï¸ æš‚åœç›‘æ§';
                btn.className = 'btn-warning';
                console.log('âœ… ç›‘æ§å·²æ¢å¤ï¼ŒSQLæŸ¥è¯¢å·²å¯åŠ¨');
            }
        }
        
        // ==================== å†å²æ•°æ®æŸ¥çœ‹ ====================
        /**
         * æŸ¥çœ‹å†å²æ•°æ®
         * æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´èŒƒå›´åŠ è½½å†å²ä½™é¢æ•°æ®
         */
        async function viewHistory() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            // éªŒè¯æ—¶é—´é€‰æ‹©
            if (!startTime || !endTime) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
                return;
            }
            
            const startTimestamp = new Date(startTime).getTime();
            const endTimestamp = new Date(endTime).getTime();
            
            if (startTimestamp >= endTimestamp) {
                alert('å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´');
                return;
            }
            
            try {
                // è¯·æ±‚å†å²æ•°æ®
                const response = await fetch(`/api/balance/history?start=${startTimestamp}&end=${endTimestamp}`);
                if (!response.ok) {
                    throw new Error('è·å–å†å²æ•°æ®å¤±è´¥');
                }
                
                const result = await response.json();
                if (result.code !== 200) {
                    throw new Error(result.message);
                }
                
                // åˆ‡æ¢åˆ°å†å²æ¨¡å¼
                isHistoryMode = true;
                updateModeIndicator();
                
                // æ˜¾ç¤ºè¿”å›å®æ—¶æŒ‰é’®
                document.getElementById('realtimeBtn').classList.remove('hidden');
                
                // æ¸²æŸ“å†å²æ•°æ®
                renderHistoryChart(result.data);
                
                console.log(`ğŸ“Š å·²åŠ è½½ ${result.data.length} æ¡å†å²æ•°æ®`);
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½å†å²æ•°æ®å¤±è´¥: ' + error.message);
            }
        }
        
        /**
         * æ¸²æŸ“å†å²æ•°æ®åˆ°å›¾è¡¨
         * @param {Array} historyData - å†å²æ•°æ®æ•°ç»„
         */
        function renderHistoryChart(historyData) {
            if (!historyData || historyData.length === 0) {
                alert('æ‰€é€‰æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ•°æ®');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰æ•°æ®
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.data.datasets[1].data = [];
            
            // å¡«å……å†å²æ•°æ®
            historyData.forEach(item => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                chart.data.labels.push(time);
                chart.data.datasets[0].data.push(item.actual_balance / 100);
                chart.data.datasets[1].data.push(item.expected_balance / 100);
            });
            
            // æ›´æ–°å›¾è¡¨
            chart.update();
        }
        
        /**
         * åˆ‡æ¢å›å®æ—¶æ¨¡å¼
         * æ¸…ç©ºå†å²æ•°æ®ï¼Œæ¢å¤å®æ—¶æ›´æ–°
         */
        function switchToRealtime() {
            // åˆ‡æ¢å›å®æ—¶æ¨¡å¼
            isHistoryMode = false;
            updateModeIndicator();
            
            // éšè—è¿”å›å®æ—¶æŒ‰é’®
            document.getElementById('realtimeBtn').classList.add('hidden');
            
            // æ¸…ç©ºå›¾è¡¨
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.data.datasets[1].data = [];
            chart.update();
            
            // æ¸…ç©ºæ—¶é—´é€‰æ‹©
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            
            console.log('ğŸ”´ å·²åˆ‡æ¢å›å®æ—¶æ¨¡å¼');
        }
        
        /**
         * æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
         */
        function updateModeIndicator() {
            const indicator = document.getElementById('modeIndicator');
            if (isHistoryMode) {
                indicator.className = 'mode-indicator history';
                indicator.textContent = 'ğŸ“… å†å²æ¨¡å¼';
            } else {
                indicator.className = 'mode-indicator realtime';
                indicator.textContent = 'ğŸ”´ å®æ—¶æ¨¡å¼';
            }
        }
        
        // ==================== æ¸…ç©ºè¿½è¸ª ====================
        /**
         * æ¸…ç©ºæ—¶åºè¿½è¸ªåˆ—è¡¨
         */
        function clearTraces() {
            document.getElementById('traceList').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    ç­‰å¾…å¹¶å‘è¯·æ±‚...
                </div>
            `;
        }
        
        // ==================== æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ ====================
        /**
         * åˆ‡æ¢åŠ é”æ¨¡å¼
         */
        async function toggleLockMode() {
            const lockToggle = document.getElementById('lockToggle');
            const newMode = lockToggle.checked;
            
            try {
                const response = await fetch('/api/mode/switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        use_lock: newMode
                    })
                });
                
                if (!response.ok) {
                    throw new Error('åˆ‡æ¢æ¨¡å¼å¤±è´¥');
                }
                
                const result = await response.json();
                console.log('æ¨¡å¼åˆ‡æ¢æˆåŠŸ:', result.data);
                
                // æ›´æ–°UI
                updateLockModeUI(newMode);
                
            } catch (error) {
                console.error('åˆ‡æ¢æ¨¡å¼å¤±è´¥:', error);
                // æ¢å¤toggleçŠ¶æ€
                lockToggle.checked = !newMode;
                alert('åˆ‡æ¢æ¨¡å¼å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        /**
         * æ›´æ–°é”æ¨¡å¼UIæ˜¾ç¤º
         * @param {boolean} lockMode - æ˜¯å¦å¯ç”¨åŠ é”æ¨¡å¼
         */
        function updateLockModeUI(lockMode) {
            const lockToggle = document.getElementById('lockToggle');
            const lockStatus = document.getElementById('lockStatus');
            const unlockedBlock = document.getElementById('unlockedCodeBlock');
            const lockedBlock = document.getElementById('lockedCodeBlock');
            
            // æ›´æ–°toggleå¼€å…³
            lockToggle.checked = lockMode;
            
            // æ›´æ–°çŠ¶æ€æ ‡ç­¾
            if (lockMode) {
                lockStatus.className = 'lock-status locked';
                lockStatus.innerHTML = '<span class="lock-icon">ğŸ”’</span><span>å·²åŠ é”</span>';
                
                // é«˜äº®åŠ é”ç‰ˆæœ¬ä»£ç 
                unlockedBlock.classList.remove('active');
                lockedBlock.classList.add('active');
            } else {
                lockStatus.className = 'lock-status unlocked';
                lockStatus.innerHTML = '<span class="lock-icon">ğŸ”“</span><span>æ— é”</span>';
                
                // é«˜äº®æ— é”ç‰ˆæœ¬ä»£ç 
                unlockedBlock.classList.add('active');
                lockedBlock.classList.remove('active');
            }
            
            console.log('UIå·²æ›´æ–°ï¼Œå½“å‰æ¨¡å¼:', lockMode ? 'åŠ é”' : 'æ— é”');
        }
        
        /**
         * è·å–å½“å‰æ¨¡å¼çŠ¶æ€
         */
        async function getCurrentMode() {
            try {
                const response = await fetch('/api/mode/status');
                if (response.ok) {
                    const result = await response.json();
                    updateLockModeUI(result.data.use_lock);
                }
            } catch (error) {
                console.error('è·å–æ¨¡å¼çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // ==================== åˆå§‹åŒ– ====================
        /**
         * é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–æ“ä½œ
         */
        window.onload = async () => {
            // åˆå§‹åŒ–ä»£ç é«˜äº®
            hljs.highlightAll();
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // å»ºç«‹WebSocketè¿æ¥
            connectWebSocket();
            
            // è·å–å¹¶è®¾ç½®åˆå§‹ç›‘æ§çŠ¶æ€
            try {
                const response = await fetch('/api/monitoring/status');
                if (response.ok) {
                    const result = await response.json();
                    updateMonitoringButton(result.data.status);
                }
            } catch (error) {
                console.error('è·å–ç›‘æ§çŠ¶æ€å¤±è´¥:', error);
            }
            
            // è·å–å¹¶è®¾ç½®åˆå§‹æ¨¡å¼çŠ¶æ€
            await getCurrentMode();
        };
    </script>
</body>
</html>
